<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹æ¸¬é‡æ¨¡æ“¬å¯¦é©—å®¤ (Full View)</title>
    <style>
        /* =========================================
           1. æ ¸å¿ƒè¨­å®šï¼šé–å®šä¸€é  (No Scroll)
           ========================================= */
        :root {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --text-main: #f0f0f0;
            --text-muted: #aaaaaa;
            --primary: #4db8ff;
            --accent: #ffcc00;
            --danger: #ff5555;
            --border: #444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            width: 100%;
            height: 100%; /* å¼·åˆ¶å¡«æ»¿è¦–çª— */
            overflow: hidden; /* ç¦æ­¢æ²è»¸ */
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           2. é ‚éƒ¨å€åŸŸ (Header & Tabs)
           ========================================= */
        header {
            flex: 0 0 auto; /* å›ºå®šé«˜åº¦ï¼Œä¸ä¼¸ç¸® */
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-size: 1.5rem; color: var(--primary); letter-spacing: 1px; margin: 0; }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 8px 20px;
            cursor: pointer;
            font-size: 1.1rem; /* å­—é«”åŠ å¤§ */
            font-weight: 600;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        /* =========================================
           3. ä¸»å…§å®¹å€ (è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“)
           ========================================= */
        main {
            flex: 1 1 auto; /* ä½”æ“šå‰©é¤˜é«˜åº¦ */
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden; /* å…§éƒ¨ä¹Ÿä¸æ²å‹• */
            position: relative;
        }

        .module-section {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }
        .module-section.active { display: flex; }

        /* =========================================
           4. L1 æ¨£å¼ï¼šä¸Šæ–¹å„€è¡¨æ¿ + ä¸‹æ–¹ç•«å¸ƒ
           ========================================= */
        .dashboard-row {
            flex: 0 0 auto;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            background: var(--bg-panel);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .data-card {
            flex: 1;
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            border-left: 5px solid var(--primary);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .data-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 4px; }
        .data-value { font-size: 1.6rem; font-weight: bold; font-family: monospace; white-space: nowrap;}

        /* =========================================
           5. L2 æ¨£å¼ï¼šå·¦å´æ§åˆ¶ + å³å´ç•«å¸ƒ
           ========================================= */
        .split-layout {
            display: flex;
            height: 100%;
            gap: 10px;
        }

        .control-panel {
            flex: 0 0 320px; /* å›ºå®šå¯¬åº¦ 320px */
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* è‹¥è¢å¹•å¤ªçŸ®ï¼Œåªæœ‰å´é‚Šæ¬„å¯æ²å‹• */
        }

        .control-group { margin-bottom: 25px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        input[type="range"] { width: 100%; height: 25px; accent-color: var(--primary); cursor: pointer; }

        .results-table { margin-top: auto; padding-top: 20px; border-top: 1px dashed var(--border); }
        .result-row { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 10px; color: var(--text-muted); }
        .result-row strong { color: var(--accent); font-size: 1.3rem; }

        .btn-action {
            width: 100%; padding: 15px; margin-top: 15px;
            background: var(--success); color: white; border: none; border-radius: 6px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
        }
        .btn-action:hover { filter: brightness(1.1); }

        /* =========================================
           6. Canvas å…±ç”¨èˆ‡ä¿®æ­£
           ========================================= */
        .canvas-container {
            flex: 1; /* è‡ªå‹•å¡«æ»¿ */
            position: relative;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        canvas {
            display: block; /* æ¶ˆé™¤åº•éƒ¨ç™½é‚Š */
            width: 100%;
            height: 100%;
            background-color: #0d1117;
            cursor: crosshair;
        }

        #surveyCanvas {
            background-image: linear-gradient(rgba(50,255,50,0.1) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(50,255,50,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>
</head>
<body>

    <header>
        <h1>CIVIL LAB</h1>
        <nav class="tabs">
            <button class="tab-btn active" onclick="App.switchTab('survey')">ğŸ“ æ¸¬é‡åº§æ¨™</button>
            <button class="tab-btn" onclick="App.switchTab('curve')">ğŸ›£ï¸ é“è·¯æ›²ç·š</button>
        </nav>
    </header>

    <main>
        <!-- MODULE 1: Surveying -->
        <section id="module-survey" class="module-section active">
            <!-- ä¸Šæ–¹æ•¸æ“šåˆ— -->
            <div class="dashboard-row">
                <div class="data-card">
                    <span class="data-label">èµ·é» A (Start)</span>
                    <span id="s_coordA" class="data-value">N:0.00 E:0.00</span>
                </div>
                <div class="data-card">
                    <span class="data-label">çµ‚é» B (End)</span>
                    <span id="s_coordB" class="data-value">N:0.00 E:0.00</span>
                </div>
                <div class="data-card" style="border-left-color: var(--accent);">
                    <span class="data-label">è·é›¢ (Dist)</span>
                    <span id="s_distVal" class="data-value" style="color:var(--accent)">0.000m</span>
                </div>
                <div class="data-card" style="border-left-color: var(--danger);">
                    <span class="data-label">æ–¹ä½è§’ (Azimuth)</span>
                    <span id="s_aziVal" class="data-value" style="color:var(--danger)">0Â°00'00"</span>
                </div>
            </div>
            
            <!-- ä¸‹æ–¹ç•«å¸ƒ (è‡ªå‹•å¡«æ»¿) -->
            <div class="canvas-container" id="survey-container">
                <canvas id="surveyCanvas"></canvas>
            </div>
        </section>

        <!-- MODULE 2: Curves -->
        <section id="module-curve" class="module-section">
            <div class="split-layout">
                <!-- å·¦å´æ§åˆ¶ -->
                <div class="control-panel">
                    <div class="control-group">
                        <label>è½‰æŠ˜è§’ Î”: <span id="c_valDelta" style="color:var(--primary)">60Â°</span></label>
                        <input type="range" id="c_inDelta" min="10" max="150" value="60">
                    </div>
                    <div class="control-group">
                        <label>åŠå¾‘ R: <span id="c_valR" style="color:var(--primary)">200m</span></label>
                        <input type="range" id="c_inR" min="50" max="500" step="10" value="200">
                    </div>
                    
                    <div class="results-table">
                        <div class="result-row"><span>åˆ‡ç·šé•· (T)</span><strong id="c_outT">--</strong></div>
                        <div class="result-row"><span>æ›²ç·šé•· (L)</span><strong id="c_outL">--</strong></div>
                        <div class="result-row"><span>å¤–è· (E)</span><strong id="c_outE">--</strong></div>
                        <div class="result-row"><span>é•·å¼¦ (LC)</span><strong id="c_outLC">--</strong></div>
                    </div>

                    <button class="btn-action" onclick="CurveModule.startAnimation()">ğŸš— åŸ·è¡Œæ¨¡æ“¬</button>
                </div>

                <!-- å³å´ç•«å¸ƒ -->
                <div class="canvas-container" id="curve-container">
                    <canvas id="curveCanvas"></canvas>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * GLOBAL CONTROLLER
         */
        const App = {
            switchTab: function(tabName) {
                // UI åˆ‡æ›
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                document.querySelectorAll('.module-section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(`module-${tabName}`).classList.add('active');

                // é—œéµä¿®æ­£ï¼šåˆ‡æ› Tab å¾Œç«‹å³é‡æ–°è¨ˆç®—å°ºå¯¸èˆ‡é‡ç¹ª
                // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM `display:flex` å·²ç¶“ç”Ÿæ•ˆï¼Œé€™æ¨£ offsetWidth æ‰æ˜¯æ­£ç¢ºçš„
                setTimeout(() => {
                    if(tabName === 'survey') SurveyModule.resizeAndDraw();
                    if(tabName === 'curve') CurveModule.resizeAndDraw();
                }, 10);
            }
        };

        /**
         * MODULE 1: SURVEYING (L1)
         */
        const SurveyModule = (function() {
            const canvas = document.getElementById('surveyCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('survey-container');
            
            let state = {
                step: 0,
                p1: { x: 0, y: 0, N: 0, E: 0 },
                p2: { x: 0, y: 0, N: 0, E: 0 },
                currentMouse: null
            };

            const ORIGIN_N = 1000;
            const ORIGIN_E = 1000;

            function resizeAndDraw() {
                // è®“ Canvas å…§éƒ¨è§£æåº¦ç­‰æ–¼å®¹å™¨é¡¯ç¤ºå¤§å°
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                draw();
            }

            // è¦–çª—ç¸®æ”¾æ™‚è§¸ç™¼
            window.addEventListener('resize', resizeAndDraw);

            function getSurveyCoords(canvasX, canvasY) {
                // N, E è½‰æ›
                const E = ORIGIN_E + (canvasX - canvas.width / 2);
                const N = ORIGIN_N - (canvasY - canvas.height / 2);
                return { N, E };
            }

            function computeGeo(p1, p2) {
                const dN = p2.N - p1.N;
                const dE = p2.E - p1.E;
                const dist = Math.sqrt(dN*dN + dE*dE);
                let azimuthRad = Math.atan2(dE, dN);
                let azimuthDeg = azimuthRad * (180 / Math.PI);
                if (azimuthDeg < 0) azimuthDeg += 360;
                return { dist, azimuthDeg };
            }

            function formatDMS(deg) {
                const d = Math.floor(deg);
                const m = Math.floor((deg - d) * 60);
                const s = Math.round(((deg - d) * 60 - m) * 60);
                return `${d}Â° ${String(m).padStart(2,'0')}' ${String(s).padStart(2,'0')}"`;
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawNorthArrow();

                if (state.step >= 1) {
                    drawPoint(state.p1.x, state.p1.y, 'A');
                    
                    let target = (state.step === 2) ? state.p2 : state.currentMouse;
                    
                    // ä¿®æ­£ï¼šå¿…é ˆè¦æœ‰ target æ‰ç•«ç·š
                    if (state.step === 1 && state.currentMouse) {
                        drawLine(state.p1, state.currentMouse, true);
                        updateUI(state.p1, state.currentMouse);
                    } else if (state.step === 2) {
                        drawPoint(state.p2.x, state.p2.y, 'B');
                        drawLine(state.p1, state.p2, false);
                        updateUI(state.p1, state.p2);
                    }
                }
            }

            function drawNorthArrow() {
                const x = canvas.width - 50;
                const y = 50;
                ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y+40);
                ctx.lineTo(x-8, y+10); ctx.moveTo(x, y); ctx.lineTo(x+8, y+10); ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.font = '20px Arial'; ctx.fillText('N', x-7, y-5);
            }

            function drawPoint(x, y, label) {
                ctx.fillStyle = '#4db8ff';
                ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.font = 'bold 20px Arial'; ctx.fillText(label, x+10, y-5);
            }

            function drawLine(pStart, pEnd, isDashed) {
                ctx.strokeStyle = '#ffcc00'; ctx.lineWidth = 2;
                ctx.setLineDash(isDashed ? [6, 6] : []);
                ctx.beginPath(); ctx.moveTo(pStart.x, pStart.y); ctx.lineTo(pEnd.x, pEnd.y); ctx.stroke();
                ctx.setLineDash([]);
                
                // ç•«å¼§
                const r = 50;
                const geo = computeGeo(pStart, pEnd); // é€™è£¡å‚³å…¥çš„ pStart, pEnd å·²åŒ…å« N, E
                let startAngle = -Math.PI / 2;
                let endAngle = startAngle + (geo.azimuthDeg * Math.PI / 180);
                
                ctx.strokeStyle = '#ff5555'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(pStart.x, pStart.y); ctx.lineTo(pStart.x, pStart.y - r); ctx.stroke();
                ctx.beginPath(); ctx.arc(pStart.x, pStart.y, r - 10, startAngle, endAngle, false); ctx.stroke();
            }

            function updateUI(p1, p2) {
                // ä½¿ç”¨ innerHTML åŠ æ›è¡Œè®“å¤§å­—ä¸æ“ 
                document.getElementById('s_coordA').innerHTML = `N:${p1.N.toFixed(2)} <br> E:${p1.E.toFixed(2)}`;
                document.getElementById('s_coordB').innerHTML = `N:${p2.N.toFixed(2)} <br> E:${p2.E.toFixed(2)}`;
                const res = computeGeo(p1, p2);
                document.getElementById('s_distVal').textContent = res.dist.toFixed(3) + 'm';
                document.getElementById('s_aziVal').textContent = formatDMS(res.azimuthDeg);
            }

            // äº‹ä»¶ç›£è½ - ä¿®æ­£åº§æ¨™è¨ˆç®—
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                // å› ç‚º canvas.width = rect.width (åœ¨ resizeAndDraw è¨­å®š)ï¼Œæ‰€ä»¥ 1:1 å°æ‡‰
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            canvas.addEventListener('mousemove', (e) => {
                if (state.step === 1) {
                    const pos = getMousePos(e);
                    const coords = getSurveyCoords(pos.x, pos.y);
                    state.currentMouse = { x: pos.x, y: pos.y, N: coords.N, E: coords.E };
                    draw();
                }
            });

            canvas.addEventListener('click', (e) => {
                const pos = getMousePos(e);
                const coords = getSurveyCoords(pos.x, pos.y);
                const pData = { x: pos.x, y: pos.y, N: coords.N, E: coords.E };

                if (state.step === 0 || state.step === 2) {
                    state.step = 1;
                    state.p1 = pData;
                    state.p2 = null;
                    state.currentMouse = pData;
                } else {
                    state.step = 2;
                    state.p2 = pData;
                }
                draw();
            });

            // åˆå§‹åŒ–
            setTimeout(resizeAndDraw, 100);
            return { resizeAndDraw };
        })();

        /**
         * MODULE 2: CURVE (L2)
         */
        const CurveModule = (function() {
            const canvas = document.getElementById('curveCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('curve-container');

            // Inputs
            const inputDelta = document.getElementById('c_inDelta');
            const inputR = document.getElementById('c_inR');

            let R = 200, Delta = 60;
            let T, L, E_val, LC;
            let animProgress = 0, isAnimating = false;

            function resizeAndDraw() {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                update();
            }
            window.addEventListener('resize', resizeAndDraw);

            function update() {
                Delta = parseFloat(inputDelta.value);
                R = parseFloat(inputR.value);

                document.getElementById('c_valDelta').innerText = Delta + "Â°";
                document.getElementById('c_valR').innerText = R + "m";

                const dRad = Delta * Math.PI / 180;
                const halfD = dRad / 2;
                
                T = R * Math.tan(halfD);
                L = R * dRad;
                E_val = R * (1 / Math.cos(halfD) - 1);
                LC = 2 * R * Math.sin(halfD);

                document.getElementById('c_outT').innerText = T.toFixed(3) + " m";
                document.getElementById('c_outL').innerText = L.toFixed(3) + " m";
                document.getElementById('c_outE').innerText = E_val.toFixed(3) + " m";
                document.getElementById('c_outLC').innerText = LC.toFixed(3) + " m";

                draw();
            }

            function draw() {
                const w = canvas.width;
                const h = canvas.height;
                ctx.clearRect(0, 0, w, h);

                // è‡ªå‹•ç¸®æ”¾é‚è¼¯ï¼šè®“æ›²ç·šé©æ‡‰ç•«å¸ƒ
                // ç¸½é«˜åº¦éœ€æ±‚ç´„ R + Eï¼Œä¿ç•™ä¸€äº›é‚Šè·
                let requiredH = R + E_val + 50; 
                let scale = (h * 0.8) / requiredH; 
                if (scale > 2) scale = 2; 

                const cx = w / 2;
                const cy = h - 50; // åœ“å¿ƒåœ¨ä¸‹æ–¹

                ctx.save();
                ctx.translate(cx, cy);
                ctx.scale(scale, -scale); // Yè»¸ç¿»è½‰å‘ä¸Š

                const dRad = Delta * Math.PI / 180;
                const angBC = (Math.PI/2) - (dRad/2);
                const angEC = (Math.PI/2) + (dRad/2);
                
                const ptBC = { x: R * Math.cos(angBC), y: R * Math.sin(angBC) };
                const ptEC = { x: R * Math.cos(angEC), y: R * Math.sin(angEC) };
                const ptPI = { x: 0, y: R + E_val };

                // ç•«è™›ç·šåŠå¾‘
                ctx.strokeStyle = '#555'; ctx.setLineDash([5,5]); ctx.lineWidth = 1/scale;
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(ptBC.x, ptBC.y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(ptEC.x, ptEC.y); ctx.stroke();
                ctx.setLineDash([]);

                // ç•«åˆ‡ç·š (ç´…)
                ctx.strokeStyle = '#ff5555'; ctx.lineWidth = 3/scale;
                ctx.beginPath(); ctx.moveTo(ptBC.x, ptBC.y); ctx.lineTo(ptPI.x, ptPI.y); ctx.lineTo(ptEC.x, ptEC.y); ctx.stroke();

                // ç•«æ›²ç·š (è—)
                ctx.strokeStyle = '#4db8ff'; ctx.lineWidth = 5/scale;
                ctx.beginPath(); ctx.arc(0, 0, R, angBC, angEC); ctx.stroke();

                // ç•«é»
                drawPt(ptBC, "BC"); drawPt(ptEC, "EC"); drawPt(ptPI, "PI"); drawPt({x:0,y:0}, "O");

                // å‹•ç•«
                if (isAnimating) {
                    const curAng = angBC + (angEC - angBC) * animProgress;
                    const cX = R * Math.cos(curAng);
                    const cY = R * Math.sin(curAng);
                    
                    ctx.fillStyle = '#ffcc00';
                    ctx.beginPath(); ctx.arc(cX, cY, 8/scale, 0, Math.PI*2); ctx.fill();
                    
                    // è»Šç‡ˆ
                    const tAng = curAng + Math.PI/2;
                    ctx.strokeStyle = 'rgba(255,255,0,0.8)'; ctx.lineWidth = 4/scale;
                    ctx.beginPath(); ctx.moveTo(cX, cY);
                    ctx.lineTo(cX + 40*Math.cos(tAng), cY + 40*Math.sin(tAng)); ctx.stroke();
                }

                ctx.restore();
            }

            function drawPt(pt, txt) {
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 5, 0, Math.PI*2); ctx.fill();
                ctx.save();
                ctx.scale(1, -1);
                ctx.fillStyle = '#ccc'; 
                // å­—é«”å¤§å°å›ºå®šï¼Œä¸éš¨ scale ç¸®æ”¾å¤ªèª‡å¼µ
                ctx.font = '20px Arial'; 
                ctx.fillText(txt, pt.x+10, -pt.y-10);
                ctx.restore();
            }

            function startAnimation() {
                if(isAnimating) return;
                isAnimating = true; animProgress = 0;
                let lastT = Date.now();
                function loop() {
                    if(!isAnimating) return;
                    let now = Date.now();
                    let dt = now - lastT; lastT = now;
                    animProgress += dt * 0.0005;
                    if(animProgress >= 1) { animProgress=1; isAnimating=false; }
                    draw();
                    if(isAnimating) requestAnimationFrame(loop);
                }
                loop();
            }

            inputDelta.addEventListener('input', update);
            inputR.addEventListener('input', update);
            
            return { resizeAndDraw, startAnimation };
        })();

        // å•Ÿå‹•
        window.onload = function() {
            SurveyModule.resizeAndDraw();
        };
    </script>
</body>
</html>